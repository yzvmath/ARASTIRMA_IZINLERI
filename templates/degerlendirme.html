{% extends "base.html" %}
{% block title %}{{ basvuru.basvuru_no }} - DeÄŸerlendirme{% endblock %}

{% block content %}

<!-- Print Header (Visible only when printing) -->
<div class="print-header d-none">
    <h1>ARAÅTIRMA Ä°ZNÄ° EKSÄ°KLÄ°K BÄ°LDÄ°RÄ°M RAPORU</h1>
    <p>T.C. MÄ°LLÄ° EÄÄ°TÄ°M BAKANLIÄI</p>
    <p>BaÅŸvuru No: {{ basvuru.basvuru_no }} | Tarih: {{ basvuru.olusturma_tarihi.strftime('%d.%m.%Y') if
        basvuru.olusturma_tarihi else '-' }}</p>
    <p>AraÅŸtÄ±rmacÄ±: {{ basvuru.ad_soyad }}</p>
</div>

<form action="{{ url_for('degerlendirme_kaydet', id=basvuru.id) }}" method="POST" id="degerlendirmeForm">
    <input type="hidden" name="action" id="formAction" value="kaydet">

    <!-- Ãœst Bar: Geri + YazdÄ±r + Kaydet -->
    <div class="d-flex justify-content-between align-items-center mb-4 no-print">
        <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i>Listeye DÃ¶n
        </a>
        {% set is_on_tamam = (basvuru.basvuru_durumu == 'Ã–n DeÄŸerlendirme TamamlandÄ±') %}
        {% set status_class = 'primary' if is_on_tamam else basvuru.degerlendirme_durumu|durum_renk %}
        <span class="badge bg-{{ status_class }}-subtle text-{{ status_class }} fs-6 py-2 px-3 shadow-sm">
            <i class="bi {{ basvuru.degerlendirme_durumu|durum_ikon }} me-1"></i>
            {{ basvuru.basvuru_durumu or basvuru.degerlendirme_durumu|durum_metin }}
        </span>
        <button type="button" class="btn btn-outline-secondary btn-lg px-3" onclick="window.print()" title="YazdÄ±r">
            <i class="bi bi-printer me-1"></i>YazdÄ±r
        </button>
        <button type="submit" class="btn btn-success btn-lg px-4"
            onclick="document.getElementById('formAction').value='kaydet'">
            <i class="bi bi-save me-1"></i>Kaydet
        </button>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- BÃ–LÃœM 1: BAÅVURU BÄ°LGÄ°LERÄ°                                       -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="card glass-card mb-4">
        <div class="card-header section-header section-header--blue">
            <h5 class="mb-0"><i class="bi bi-person-badge me-2"></i>BaÅŸvuru Bilgileri</h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <div class="info-item">
                        <span class="info-label">BaÅŸvuru No</span>
                        <span class="info-value fw-bold text-primary">{{ basvuru.basvuru_no }}</span>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="info-item">
                        <span class="info-label">BaÅŸvuru Tarihi</span>
                        <span class="info-value">{{ basvuru.basvuru_tarihi or '-' }}</span>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="info-item">
                        <span class="info-label">Uygulama YapÄ±lacak Kurum TÃ¼rÃ¼</span>
                        <span class="info-value">{{ basvuru.teskilat_turu or '-' }}</span>
                    </div>
                </div>
                <div class="col-12">
                    <div class="info-item">
                        <span class="info-label">AraÅŸtÄ±rmanÄ±n AdÄ±</span>
                        <span class="info-value">{{ basvuru.arastirma_adi or '-' }}</span>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="info-item">
                        <span class="info-label">NiteliÄŸi</span>
                        <span class="info-value">{{ basvuru.arastirma_niteligi or '-' }}</span>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="info-item">
                        <span class="info-label">AraÅŸtÄ±rmacÄ±</span>
                        <span class="info-value">{{ basvuru.ad_soyad or '-' }}</span>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="info-item">
                        <span class="info-label">TC Kimlik No</span>
                        <span class="info-value">{{ basvuru.tc_kimlik or '-' }}</span>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="info-item">
                        <span class="info-label">Telefon</span>
                        <span class="info-value">{{ basvuru.telefon or '-' }}</span>
                    </div>
                </div>
            </div>

            <!-- Belgeler -->
            {% if belgeler %}
            <hr class="my-3">
            <h6 class="text-muted mb-3"><i class="bi bi-file-earmark-text me-1"></i>YÃ¼klenen Belgeler</h6>
            <div class="row g-2">
                {% set belge_listesi = [
                ('AraÅŸtÄ±rma Proje Bilgileri', belgeler.arastirma_proje),
                ('Veri Toplama AracÄ± / AraÃ§larÄ±', belgeler.veri_toplama),
                ('AraÅŸtÄ±rma Uygulama Ä°zni BaÅŸvuru TaahhÃ¼tnamesi', belgeler.taahhutname),
                ('AraÅŸtÄ±rma/TÄ±bbi AraÅŸtÄ±rmalar Ä°Ã§in Etik Kuruldan AlÄ±nan Onay Belgesi', belgeler.etik_kurul),
                ('AyrÄ±ntÄ±lÄ± Bilgilendirme ve GÃ¶nÃ¼llÃ¼ KatÄ±lÄ±m Formu', belgeler.gonullu_katilim),
                ('Veli Onam Formu', belgeler.veli_onam),
                ('AlanyazÄ±nda Daha Ã–nce KullanÄ±lmÄ±ÅŸ Veri Toplama AracÄ± Tercih Ediliyor Ä°se KullanÄ±ma Ä°liÅŸkin Ä°zin',
                belgeler.olcek_izni),
                ('EnstitÃ¼ YÃ¶netim Kurulu KararÄ±', belgeler.enstitu_karari),
                ] %}
                {% for baslik, linkler in belge_listesi %}
                {% if linkler %}
                <div class="col-md-6 col-lg-4">
                    <div class="belge-card h-100">
                        <div class="d-flex align-items-start">
                            {% if 'AraÅŸtÄ±rma Proje' in baslik %}
                            <i class="bi bi-file-earmark-pdf text-primary me-2 fs-5"></i>
                            {% elif 'Veri Toplama AracÄ±' in baslik %}
                            <i class="bi bi-card-checklist text-success me-2 fs-5"></i>
                            {% elif 'TaahhÃ¼tname' in baslik %}
                            <i class="bi bi-file-earmark-check text-success me-2 fs-5"></i>
                            {% elif 'Etik Kurul' in baslik %}
                            <i class="bi bi-shield-check text-warning me-2 fs-5"></i>
                            {% elif 'GÃ¶nÃ¼llÃ¼ KatÄ±lÄ±m' in baslik %}
                            <i class="bi bi-person-check text-info me-2 fs-5"></i>
                            {% elif 'Veli Onam' in baslik %}
                            <i class="bi bi-people text-info me-2 fs-5"></i>
                            {% elif 'Ä°zin' in baslik %}
                            <i class="bi bi-file-earmark-lock text-danger me-2 fs-5"></i>
                            {% else %}
                            <i class="bi bi-file-earmark-text text-secondary me-2 fs-5"></i>
                            {% endif %}
                            <div class="w-100">
                                <div class="fw-bold text-dark mb-1" style="font-size: 0.85rem;">{{ baslik }}</div>
                                {% for link in linkler %}
                                <div class="mb-1 d-flex align-items-center">
                                    <i class="bi bi-file-earmark-arrow-down text-muted small me-1"></i>
                                    {% set doc_title = basvuru.ad_soyad + " - " + baslik + " - " + (link.clean_text
                                    if
                                    link.clean_text else link.text) %}
                                    {% set final_url = url_for('proxy_belge', url=link.url, title=doc_title) if
                                    (link.url.startswith('http') or not link.local_path)
                                    else url_for('serve_doc', filename=link.local_path, title=doc_title) %}
                                    <button type="button"
                                        class="btn btn-link p-0 text-start text-decoration-none text-truncate flex-grow-1"
                                        style="font-size: 0.8rem; max-width: 100%;"
                                        title="{{ link.clean_text if link.clean_text else link.text }}"
                                        onclick='belgeGoster({{ final_url|tojson }}, {{ (baslik + " - " + (link.clean_text if link.clean_text else link.text))|tojson }})'>
                                        {{ link.clean_text if link.clean_text else link.text }}
                                    </button>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- BÃ–LÃœM 2: DEÄERLENDÄ°RÄ°CÄ° ATAMA                                    -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="card glass-card mb-4">
        <div class="card-header section-header section-header--purple">
            <h5 class="mb-0"><i class="bi bi-people-fill me-2"></i>DeÄŸerlendirici Atama <small class="opacity-75">(en
                    fazla 2 kiÅŸi seÃ§in)</small></h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                {% for d in degerlendiriciler %}
                <div class="col-md-6 col-lg-3">
                    <label class="deg-card {{ 'deg-card--selected' if d in atanmis_degerlendiriciler }}">
                        <input type="checkbox" name="degerlendiriciler" value="{{ d }}" class="deg-checkbox"
                            {{ 'checked' if d in atanmis_degerlendiriciler }}>
                        <div class="deg-card-body">
                            <i class="bi bi-person-circle deg-avatar"></i>
                            <span class="deg-name">{{ d }}</span>
                            <span
                                class="deg-count badge bg-{{ 'danger' if is_yuku[d] > 5 else 'warning' if is_yuku[d] > 2 else 'success' }}-subtle text-{{ 'danger' if is_yuku[d] > 5 else 'warning' if is_yuku[d] > 2 else 'success' }}">
                                {{ is_yuku[d] }} baÅŸvuru
                            </span>
                        </div>
                    </label>
                </div>
                {% endfor %}
            </div>
            <div id="degUyari" class="alert alert-warning mt-3 d-none py-2">
                <i class="bi bi-exclamation-triangle me-1"></i>En fazla 2 deÄŸerlendirici seÃ§ebilirsiniz!
            </div>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- BÃ–LÃœM 3: Ã–N KONTROL MADDELERÄ°                                    -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="card glass-card mb-4">
        <div
            class="card-header section-header section-header--orange d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-list-check me-2"></i>Ã–n Kontrol Maddeleri</h5>
            <div class="no-print d-flex gap-2">
                <button type="button" id="btnOnKontrolTemizle"
                    class="btn btn-sm btn-outline-light text-white border-white">
                    <i class="bi bi-x-circle me-1"></i>TÃ¼mÃ¼nÃ¼ Temizle
                </button>
                <button type="button" onclick="hazirlaWhatsappMesaji(true)"
                    class="btn btn-sm btn-outline-light text-white border-white">
                    <i class="bi bi-whatsapp me-1"></i>WhatsApp Ã–nizleme
                </button>
                <button type="button" id="btnOnKontrolKaydet" class="btn btn-sm btn-light text-primary fw-bold"
                    disabled>
                    <i class="bi bi-save me-1"></i>Ã–n KontrolÃ¼ Kaydet
                </button>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0" id="onKontrolTablosu">
                    <thead>
                        <tr>
                            <th class="ps-4" style="width: 320px;">Madde</th>
                            <th class="text-center" style="width: 80px;">VAR</th>
                            <th class="text-center" style="width: 80px;">YOK</th>
                            <th class="text-center" style="width: 80px;">N/A</th>
                            <th>AÃ§Ä±klama</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for ok in on_kontroller %}
                        <tr
                            class="on-kontrol-row {{ 'on-kontrol-var' if ok.durum=='VAR' }}{{ 'on-kontrol-yok' if ok.durum=='YOK' }}{{ 'on-kontrol-na' if ok.durum=='N/A' }}">
                            <td class="ps-4 fw-medium">{{ ok.madde_adi }}</td>
                            <td class="text-center">
                                <input type="radio" name="on_kontrol_durum_{{ ok.sira }}" value="VAR"
                                    class="form-check-input radio-var" {{ 'checked' if ok.durum=='VAR' }}>
                            </td>
                            <td class="text-center">
                                <input type="radio" name="on_kontrol_durum_{{ ok.sira }}" value="YOK"
                                    class="form-check-input radio-yok" {{ 'checked' if ok.durum=='YOK' }}>
                            </td>
                            <td class="text-center">
                                <input type="radio" name="on_kontrol_durum_{{ ok.sira }}" value="N/A"
                                    class="form-check-input radio-na" {{ 'checked' if ok.durum=='N/A' }}>
                            </td>
                            <td>
                                <input type="text" name="on_kontrol_aciklama_{{ ok.sira }}"
                                    value="{{ ok.aciklama or '' }}" class="form-control form-control-sm"
                                    placeholder="AÃ§Ä±klama...">
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- WhatsApp Ã–zeti (Kaydetme sonrasÄ± gÃ¶rÃ¼nÃ¼r) -->
    <div class="card glass-card mb-4 border-success animate__animated animate__fadeIn" id="whatsappPanel"
        style="display: none;">
        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
            <h6 class="mb-0"><i class="bi bi-whatsapp me-2"></i>Ã–n Kontrol DeÄŸerlendirme Ã–zeti (WhatsApp)</h6>
            <button type="button" class="btn btn-sm btn-light" onclick="whatsappKopyala()">
                <i class="bi bi-clipboard me-1"></i>Metni Kopyala
            </button>
        </div>
        <div class="card-body bg-light">
            <textarea id="whatsappIcerik" class="form-control bg-white shadow-sm" rows="12"
                style="font-family: inherit; font-size: 0.9rem; line-height: 1.5; border: 1px solid #ced4da;"></textarea>
        </div>
        <div class="card-footer py-2">
            <small class="text-muted"><i class="bi bi-info-circle me-1"></i>Bu metni kopyalayÄ±p araÅŸtÄ±rmacÄ±ya
                WhatsApp
                Ã¼zerinden iletebilirsiniz.</small>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- BÃ–LÃœM 4: KRÄ°TERLER (30 Madde)                                    -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="card glass-card mb-4">
        <div class="card-header section-header section-header--green d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-check2-square me-2"></i>DeÄŸerlendirme Kriterleri</h5>
            <div class="d-flex gap-2 no-print">
                <button type="button" class="btn btn-sm btn-outline-light" id="tumunuUygun">
                    <i class="bi bi-check-all me-1"></i>TÃ¼mÃ¼nÃ¼ Uygun
                </button>
                <button type="button" class="btn btn-sm btn-outline-light" id="tumunuTemizle">
                    <i class="bi bi-eraser me-1"></i>Temizle
                </button>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0" id="kriterTablosu">
                    <thead>
                        <tr>
                            <th class="ps-4 text-center" style="width: 60px;">No</th>
                            <th>Kriter</th>
                            <th class="text-center" style="width: 100px;">Uygun</th>
                            <th class="text-center" style="width: 100px;">Uygun DeÄŸil</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for k in kriterler %}
                        <tr class="kriter-row {{ 'kriter-uygun' if k.sonuc == 'UYGUN' }}{{ 'kriter-uygun-degil' if k.sonuc == 'UYGUN_DEGIL' }}"
                            data-kriter-no="{{ k.no }}">
                            <td class="ps-4 text-center">
                                <span class="kriter-no">{{ k.no }}</span>
                            </td>
                            <td class="kriter-metin">{{ k.metin }}</td>
                            <td class="text-center">
                                <input type="radio" name="kriter_sonuc_{{ k.no }}" value="UYGUN"
                                    class="form-check-input radio-uygun" {{ 'checked' if k.sonuc=='UYGUN' }}>
                            </td>
                            <td class="text-center">
                                <input type="radio" name="kriter_sonuc_{{ k.no }}" value="UYGUN_DEGIL"
                                    class="form-check-input radio-uygun-degil" {{ 'checked' if k.sonuc=='UYGUN_DEGIL'
                                    }}>
                            </td>
                        </tr>
                        <!-- AÃ§Ä±klama satÄ±rÄ± (Uygun DeÄŸil seÃ§ilince aÃ§Ä±lÄ±r) -->
                        <tr class="kriter-aciklama-row {{ 'show' if k.sonuc == 'UYGUN_DEGIL' }}"
                            data-aciklama-for="{{ k.no }}">
                            <td></td>
                            <td colspan="3">
                                <div class="d-flex align-items-start gap-2">
                                    <i class="bi bi-chat-left-text text-danger mt-1"></i>
                                    <textarea name="kriter_aciklama_{{ k.no }}" rows="2"
                                        class="form-control form-control-sm kriter-aciklama-input"
                                        placeholder="Uygun deÄŸil gerekÃ§esini yazÄ±n...">{{ k.aciklama or '' }}</textarea>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- BÃ–LÃœM 5: UYGUN DEÄÄ°L Ã–ZETÄ°                                      -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="card ozet-card mb-4" id="ozetKart" style="display: none;">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-exclamation-triangle me-2"></i>Uygun DeÄŸil Ã–zeti
                <span class="badge bg-light text-danger ms-2" id="ozetSayac">0</span>
            </h5>
        </div>
        <div class="card-body" id="ozetIcerik">
            <!-- JS ile doldurulacak -->
        </div>
    </div>

    <!-- Alt Kaydet + YazdÄ±r ButonlarÄ± -->
    <div class="d-flex justify-content-between align-items-center mb-5 no-print p-3 bg-white rounded shadow-sm border">
        <button type="button" class="btn btn-outline-secondary btn-lg px-4" onclick="window.print()">
            <i class="bi bi-printer me-2"></i>YazdÄ±r
        </button>

        <div class="d-flex gap-3">
            <button type="submit" class="btn btn-danger btn-lg px-4"
                onclick="document.getElementById('formAction').value='reddet'; return confirm('BaÅŸvuruyu REDDETMEK istediÄŸinizden emin misiniz?')">
                <i class="bi bi-x-circle me-2"></i>BAÅVURUYU REDDET
            </button>
            <button type="submit" class="btn btn-success btn-lg px-4"
                onclick="document.getElementById('formAction').value='onayla'; return confirm('BaÅŸvuruyu ONAYLAMAK istediÄŸinizden emin misiniz?')">
                <i class="bi bi-check2-all me-2"></i>BAÅVURUYU ONAYLA
            </button>
        </div>
    </div>

    <!-- Print Footer (Visible only when printing) -->
    <div class="print-footer d-none">
        <div class="sig-box">
            <p><strong>DeÄŸerlendirici 1</strong></p>
            <p>{{ basvuru.degerlendiriciler[0].degerlendirici_adi if basvuru.degerlendiriciler|length > 0 else
                '........................' }}</p>
            <br><br>
            <p>Ä°mza</p>
        </div>
        <div class="sig-box">
            <p><strong>DeÄŸerlendirici 2</strong></p>
            <p>{{ basvuru.degerlendiriciler[1].degerlendirici_adi if basvuru.degerlendiriciler|length > 1 else
                '........................' }}</p>
            <br><br>
            <p>Ä°mza</p>
        </div>
    </div>
</form>

<!-- Belge GÃ¶rÃ¼ntÃ¼leme ModalÄ± -->
<div class="modal fade" id="belgeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content glass-card border-0">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title" id="belgeModalLabel">Belge GÃ¶rÃ¼ntÃ¼le</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
            </div>
            <div class="modal-body">
                <div class="ratio ratio-16x9" style="min-height: 70vh;">
                    <iframe id="belgeIframe" src="" frameborder="0"></iframe>
                </div>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                <a id="belgeYeniSekme" href="#" target="_blank" class="btn btn-primary">
                    <i class="bi bi-box-arrow-up-right me-1"></i>Yeni Sekmede AÃ§
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Belge GÃ¶rÃ¼ntÃ¼leme (Pop-up)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const belgeModal = new bootstrap.Modal(document.getElementById('belgeModal'));
    const belgeIframe = document.getElementById('belgeIframe');
    const belgeModalLabel = document.getElementById('belgeModalLabel');
    const belgeYeniSekme = document.getElementById('belgeYeniSekme');

    function belgeGoster(url, baslik) {
        belgeModalLabel.textContent = baslik;
        belgeIframe.src = url;
        belgeYeniSekme.href = url;
        belgeModal.show();
    }

    // Modal kapandÄ±ÄŸÄ±nda iframe'i temizle (bellek ve ses Ã§alma vb. iÃ§in)
    document.getElementById('belgeModal').addEventListener('hidden.bs.modal', function () {
        belgeIframe.src = '';
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // DeÄŸerlendirici checkbox limiti (max 2)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const checkboxes = document.querySelectorAll('.deg-checkbox');
    const uyari = document.getElementById('degUyari');

    checkboxes.forEach(cb => {
        cb.addEventListener('change', function () {
            const checked = document.querySelectorAll('.deg-checkbox:checked');
            if (checked.length > 2) {
                this.checked = false;
                uyari.classList.remove('d-none');
                setTimeout(() => uyari.classList.add('d-none'), 3000);
                return;
            }
            this.closest('.deg-card').classList.toggle('deg-card--selected', this.checked);
        });
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Radyo Buton Deselect (TÄ±klayÄ±nca SeÃ§imi KaldÄ±rabilme)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    document.querySelectorAll('input[type="radio"]').forEach(radio => {
        radio.addEventListener('click', function (e) {
            if (this.wasChecked) {
                this.checked = false;
                this.wasChecked = false;
                // DeÄŸiÅŸiklik olayÄ±nÄ± tetikle (renklendirme vb. iÃ§in)
                this.dispatchEvent(new Event('change', { bubbles: true }));
            } else {
                // AynÄ± gruptaki diÄŸer radyo butonlarÄ± iÃ§in wasChecked'i sÄ±fÄ±rla
                document.querySelectorAll(`input[name="${this.name}"]`).forEach(r => r.wasChecked = false);
                this.wasChecked = true;
            }
        });
        // Sayfa yÃ¼klendiÄŸinde mevcut seÃ§ili olanlarÄ± iÅŸaretle
        if (radio.checked) radio.wasChecked = true;
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Ã–n Kontrol satÄ±r renklendirme
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    document.querySelectorAll('#onKontrolTablosu input[type="radio"]').forEach(radio => {
        radio.addEventListener('change', function () {
            const row = this.closest('tr');
            row.classList.remove('on-kontrol-var', 'on-kontrol-yok', 'on-kontrol-na');
            if (!this.checked) return; // SeÃ§im kaldÄ±rÄ±lmÄ±ÅŸsa renk verme

            if (this.value === 'VAR') row.classList.add('on-kontrol-var');
            else if (this.value === 'YOK') row.classList.add('on-kontrol-yok');
            else if (this.value === 'N/A') row.classList.add('on-kontrol-na');
        });
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TÃ¼mÃ¼nÃ¼ uygun yap
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    document.getElementById('tumunuUygun')?.addEventListener('click', function () {
        document.querySelectorAll('.radio-uygun').forEach(r => {
            r.checked = true;
            const row = r.closest('tr');
            row.className = 'kriter-row kriter-uygun';
            // AÃ§Ä±klama satÄ±rÄ±nÄ± gizle
            const no = row.dataset.kriterNo;
            const aciklamaRow = document.querySelector(`[data-aciklama-for="${no}"]`);
            if (aciklamaRow) aciklamaRow.classList.remove('show');
        });
        ozetiGuncelle();
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Temizle
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    document.getElementById('tumunuTemizle')?.addEventListener('click', function () {
        document.querySelectorAll('#kriterTablosu input[type="radio"]').forEach(r => {
            r.checked = false;
        });
        document.querySelectorAll('.kriter-row').forEach(row => {
            row.className = 'kriter-row';
        });
        document.querySelectorAll('.kriter-aciklama-row').forEach(row => {
            row.classList.remove('show');
        });
        ozetiGuncelle();
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Kriter satÄ±r renklendirme + aÃ§Ä±klama alanÄ± toggle
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    document.querySelectorAll('#kriterTablosu input[type="radio"]').forEach(radio => {
        radio.addEventListener('change', function () {
            const row = this.closest('tr');
            const no = row.dataset.kriterNo;
            const aciklamaRow = document.querySelector(`[data-aciklama-for="${no}"]`);

            row.classList.remove('kriter-uygun', 'kriter-uygun-degil');

            if (!this.checked) {
                if (aciklamaRow) aciklamaRow.classList.remove('show');
            } else if (this.value === 'UYGUN') {
                row.classList.add('kriter-uygun');
                if (aciklamaRow) aciklamaRow.classList.remove('show');
            } else if (this.value === 'UYGUN_DEGIL') {
                row.classList.add('kriter-uygun-degil');
                if (aciklamaRow) {
                    aciklamaRow.classList.add('show');
                    setTimeout(() => {
                        const textarea = aciklamaRow.querySelector('textarea');
                        if (textarea) textarea.focus();
                    }, 300);
                }
            }
            ozetiGuncelle();
        });
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Uygun DeÄŸil Ã–zeti â€” dinamik gÃ¼ncelleme
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function ozetiGuncelle() {
        const uygunDegilRadios = document.querySelectorAll('.radio-uygun-degil:checked');
        const ozetKart = document.getElementById('ozetKart');
        const ozetIcerik = document.getElementById('ozetIcerik');
        const ozetSayac = document.getElementById('ozetSayac');

        if (uygunDegilRadios.length === 0) {
            ozetKart.style.display = 'none';
            return;
        }

        ozetKart.style.display = 'block';

        // Toplam kriter sayÄ±sÄ±nÄ± bul
        const toplamKriter = document.querySelectorAll('.kriter-row').length;
        const uygunSayisi = document.querySelectorAll('.radio-uygun:checked').length;

        ozetSayac.textContent = `${uygunDegilRadios.length} / ${toplamKriter}`;

        let html = `<div class="mb-3">
            <strong>Toplam ${toplamKriter} kriterden ${uygunDegilRadios.length} tanesi uygun deÄŸil bulunmuÅŸtur.</strong>
            ${uygunSayisi > 0 ? ` <span class="text-success">(${uygunSayisi} kriter uygun)</span>` : ''}
        </div>`;

        html += '<div>';
        uygunDegilRadios.forEach(radio => {
            const row = radio.closest('tr');
            const no = row.dataset.kriterNo;
            const metin = row.querySelector('.kriter-metin')?.textContent?.trim() || '';
            const aciklamaRow = document.querySelector(`[data-aciklama-for="${no}"]`);
            const aciklama = aciklamaRow?.querySelector('textarea')?.value?.trim() || '';

            // Kriter metnini kÄ±salt (ilk 120 karakter)
            const kisaMetin = metin.length > 120 ? metin.substring(0, 120) + '...' : metin;

            html += `<div class="ozet-item">
                <span class="ozet-item-no">Kriter ${no}:</span> ${kisaMetin}`;
            if (aciklama) {
                html += `<br><em class="text-muted ms-3"><i class="bi bi-chat-left-text me-1"></i>${aciklama}</em>`;
            }
            html += '</div>';
        });
        html += '</div>';

        ozetIcerik.innerHTML = html;
    }

    // AÃ§Ä±klama textarea'larÄ±ndaki deÄŸiÅŸikliklerde de Ã¶zeti gÃ¼ncelle
    document.querySelectorAll('.kriter-aciklama-input').forEach(textarea => {
        textarea.addEventListener('input', ozetiGuncelle);
    });

    // Sayfa yÃ¼klendiÄŸinde Ã¶zeti hesapla
    ozetiGuncelle();

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Ã–n Kontrol Kaydetme ve WhatsApp MesajÄ±
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const btnOnKontrolKaydet = document.getElementById('btnOnKontrolKaydet');
    const onKontrolRadios = document.querySelectorAll('#onKontrolTablosu input[type="radio"]');

    function onKontrolDurumKontrol() {
        const rows = document.querySelectorAll('#onKontrolTablosu tbody tr');
        let secilenSayisi = 0;

        rows.forEach(row => {
            if (row.querySelector('input[type="radio"]:checked')) {
                secilenSayisi++;
            }
        });

        if (btnOnKontrolKaydet) {
            // En az bir tane seÃ§ilmiÅŸse kaydetmeye izin ver
            btnOnKontrolKaydet.disabled = secilenSayisi === 0;

            if (secilenSayisi > 0 && secilenSayisi < rows.length) {
                btnOnKontrolKaydet.innerHTML = `<i class="bi bi-save me-1"></i>TaslaÄŸÄ± Kaydet (${secilenSayisi}/${rows.length})`;
                btnOnKontrolKaydet.className = 'btn btn-sm btn-light text-primary fw-bold';
            } else if (secilenSayisi === rows.length) {
                btnOnKontrolKaydet.innerHTML = '<i class="bi bi-check-all me-1"></i>Ã–n KontrolÃ¼ Tamamla';
                btnOnKontrolKaydet.className = 'btn btn-sm btn-light text-orange fw-bold';
            } else { // secilenSayisi === 0
                btnOnKontrolKaydet.innerHTML = '<i class="bi bi-save me-1"></i>Kaydet';
                btnOnKontrolKaydet.className = 'btn btn-sm btn-light text-secondary fw-bold';
            }
        }
    }

    onKontrolRadios.forEach(r => r.addEventListener('change', onKontrolDurumKontrol));

    document.getElementById('btnOnKontrolTemizle')?.addEventListener('click', function () {
        if (confirm('TÃ¼m Ã¶n kontrol seÃ§imlerini temizlemek istediÄŸinizden emin misiniz?')) {
            onKontrolRadios.forEach(r => r.checked = false);
            document.querySelectorAll('#onKontrolTablosu input[type="text"]').forEach(i => i.value = '');
            document.querySelectorAll('#onKontrolTablosu tbody tr').forEach(tr => {
                tr.classList.remove('table-success', 'table-danger', 'table-warning');
            });
            onKontrolDurumKontrol();
            alert('Ã–n kontrol seÃ§imleri temizlendi.');
        }
    });

    btnOnKontrolKaydet?.addEventListener('click', function () {
        const formData = new FormData(document.getElementById('degerlendirmeForm'));

        fetch("{{ url_for('on_kontrol_kaydet', id=basvuru.id) }}", {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Durum badge'ini gÃ¼ncelle
                    const statusBadge = document.querySelector('.badge.fs-6');
                    if (statusBadge && data.new_status) {
                        statusBadge.innerHTML = `<i class="bi bi-check-all me-1"></i>${data.new_status}`;
                        statusBadge.className = 'badge bg-info-subtle text-info fs-6 py-2 px-3';
                    }

                    // WhatsApp MesajÄ± HazÄ±rla
                    hazirlaWhatsappMesaji();

                    // BaÅŸarÄ± bildirimi
                    alert("Ã–n kontrol baÅŸarÄ±yla kaydedildi.");
                } else {
                    alert("Hata: " + (data.message || "Kaydedilemedi."));
                }
            })
            .catch(error => {
                console.error('Hata:', error);
                alert("Kaydetme sÄ±rasÄ±nda bir hata oluÅŸtu.");
            });
    });

    function hazirlaWhatsappMesaji(scroll = false) {
        const adSoyad = "{{ basvuru.ad_soyad }}";
        const basvuruNo = "{{ basvuru.basvuru_no }}";

        // SeÃ§ilen deÄŸerlendiricileri al
        const secilenDegerlerlendiriciler = [];
        document.querySelectorAll('.deg-checkbox:checked').forEach(cb => {
            secilenDegerlerlendiriciler.push(cb.value);
        });

        const yokMaddeleri = [];
        let evrakEksik = false;

        // Belge sayÄ±lan maddelerin sÄ±ra numaralarÄ±: 1, 3, 4, 5, 6, 7, 8, 9, 10
        const belgeSiralar = [1, 3, 4, 5, 6, 7, 8, 9, 10];

        document.querySelectorAll('#onKontrolTablosu tbody tr').forEach((row, index) => {
            const radYok = row.querySelector('.radio-yok');
            const sira = parseInt(radYok.name.split('_').pop()); // on_kontrol_durum_X -> X

            if (radYok && radYok.checked) {
                const maddeAdi = row.querySelector('td:first-child').textContent.trim();
                const aciklama = row.querySelector('input[type="text"]').value.trim();
                yokMaddeleri.push({ ad: maddeAdi, not: aciklama });

                // EÄŸer bu madde bir "belge" ise evrak durumunu eksik yap
                if (belgeSiralar.includes(sira)) {
                    evrakEksik = true;
                }
            }
        });

        // Yeni Åablon OluÅŸturma
        let mesaj = `*${basvuruNo}*\n\n`;

        mesaj += `ğŸ“Œ Atanan deÄŸerlendiriciler:\n`;
        if (secilenDegerlerlendiriciler.length > 0) {
            secilenDegerlerlendiriciler.forEach(d => mesaj += `ğŸ‘¤ ${d}\n`);
        } else {
            mesaj += `(DeÄŸerlendirici seÃ§ilmedi)\n`;
        }
        mesaj += `\n`;

        // Evrak durumu sadece "belge" olan kalemlere gÃ¶re belirlenir
        if (evrakEksik) {
            mesaj += `ğŸ“„ Evraklar: âŒ Eksik\n\n`;
        } else {
            mesaj += `ğŸ“„ Evraklar: âœ… Tam\n\n`;
        }

        mesaj += `ğŸ“ Ã–n deÄŸerlendirme notlarÄ±:\n`;
        if (yokMaddeleri.length > 0) {
            yokMaddeleri.forEach(m => {
                mesaj += `* ${m.ad}${m.not ? ' (' + m.not + ')' : ''}\n`;
            });
        } else {
            mesaj += `* Evraklar uygun bulunmuÅŸtur.\n* [DiÄŸer notlarÄ±nÄ±zÄ± buraya ekleyebilirsiniz]`;
        }

        const panel = document.getElementById('whatsappPanel');
        const icerik = document.getElementById('whatsappIcerik');
        icerik.value = mesaj;
        panel.style.display = 'block';
        if (scroll) {
            panel.scrollIntoView({ behavior: 'smooth' });
        }
    }

    window.whatsappKopyala = function () {
        const text = document.getElementById('whatsappIcerik').value;
        navigator.clipboard.writeText(text).then(() => {
            const btn = document.querySelector('#whatsappPanel .btn-light');
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-check2 me-1"></i>KopyalandÄ±!';
            btn.classList.replace('btn-light', 'btn-success');
            btn.classList.add('text-white');
            setTimeout(() => {
                btn.innerHTML = originalHtml;
                btn.classList.replace('btn-success', 'btn-light');
                btn.classList.remove('text-white');
            }, 2000);
        });
    };

    // Sayfa yÃ¼klendiÄŸinde kontrol et
    onKontrolDurumKontrol();

    // EÄŸer 'YOK' olan maddeler varsa WhatsApp panelini otomatik gÃ¶ster
    const hasYok = document.querySelectorAll('.radio-yok:checked').length > 0;
    if (hasYok) {
        hazirlaWhatsappMesaji();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Form deÄŸiÅŸiklik uyarÄ±sÄ±
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let formChanged = false;
    document.getElementById('degerlendirmeForm').addEventListener('change', () => formChanged = true);
    document.getElementById('degerlendirmeForm').addEventListener('input', () => formChanged = true);
    window.addEventListener('beforeunload', (e) => {
        if (formChanged) {
            e.preventDefault();
            e.returnValue = '';
        }
    });
    document.getElementById('degerlendirmeForm').addEventListener('submit', () => formChanged = false);
</script>
{% endblock %}