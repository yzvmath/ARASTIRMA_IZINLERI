{% extends "base.html" %}
{% block title %}{{ basvuru.basvuru_no }} - Değerlendirme{% endblock %}

{% block content %}

<!-- Print header (only visible when printing) -->
<div class="print-header">
    <h3>MEB Araştırma Uygulama İzni Değerlendirme Raporu</h3>
    <p>{{ basvuru.basvuru_no }} — {{ basvuru.ad_soyad }} — {{ basvuru.basvuru_tarihi }}</p>
</div>

<form action="{{ url_for('degerlendirme_kaydet', id=basvuru.id) }}" method="POST" id="degerlendirmeForm">

    <!-- Üst Bar: Geri + Yazdır + Kaydet -->
    <div class="d-flex justify-content-between align-items-center mb-4 no-print">
        <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i>Listeye Dön
        </a>
        <div class="d-flex gap-2">
            <span
                class="badge bg-{{ basvuru.degerlendirme_durumu|durum_renk }}-subtle text-{{ basvuru.degerlendirme_durumu|durum_renk }} fs-6 py-2 px-3">
                <i class="bi {{ basvuru.degerlendirme_durumu|durum_ikon }} me-1"></i>
                {{ basvuru.degerlendirme_durumu|durum_metin }}
            </span>
            <button type="button" class="btn btn-outline-secondary btn-lg px-3" onclick="window.print()" title="Yazdır">
                <i class="bi bi-printer me-1"></i>Yazdır
            </button>
            <button type="submit" class="btn btn-success btn-lg px-4">
                <i class="bi bi-check2-all me-1"></i>Kaydet
            </button>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════════ -->
    <!-- BÖLÜM 1: BAŞVURU BİLGİLERİ                                       -->
    <!-- ═══════════════════════════════════════════════════════════════════ -->
    <div class="card glass-card mb-4">
        <div class="card-header section-header section-header--blue">
            <h5 class="mb-0"><i class="bi bi-person-badge me-2"></i>Başvuru Bilgileri</h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <div class="info-item">
                        <span class="info-label">Başvuru No</span>
                        <span class="info-value fw-bold text-primary">{{ basvuru.basvuru_no }}</span>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="info-item">
                        <span class="info-label">Başvuru Tarihi</span>
                        <span class="info-value">{{ basvuru.basvuru_tarihi or '-' }}</span>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="info-item">
                        <span class="info-label">Uygulama Yapılacak Kurum Türü</span>
                        <span class="info-value">{{ basvuru.teskilat_turu or '-' }}</span>
                    </div>
                </div>
                <div class="col-12">
                    <div class="info-item">
                        <span class="info-label">Araştırmanın Adı</span>
                        <span class="info-value">{{ basvuru.arastirma_adi or '-' }}</span>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="info-item">
                        <span class="info-label">Niteliği</span>
                        <span class="info-value">{{ basvuru.arastirma_niteligi or '-' }}</span>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="info-item">
                        <span class="info-label">Araştırmacı</span>
                        <span class="info-value">{{ basvuru.ad_soyad or '-' }}</span>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="info-item">
                        <span class="info-label">TC Kimlik No</span>
                        <span class="info-value">{{ basvuru.tc_kimlik or '-' }}</span>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="info-item">
                        <span class="info-label">Telefon</span>
                        <span class="info-value">{{ basvuru.telefon or '-' }}</span>
                    </div>
                </div>
            </div>

            <!-- Belgeler -->
            {% if belgeler %}
            <hr class="my-3">
            <h6 class="text-muted mb-3"><i class="bi bi-file-earmark-text me-1"></i>Yüklenen Belgeler</h6>
            <div class="row g-2">
                {% set belge_listesi = [
                ('Araştırma Proje Bilgileri', belgeler.arastirma_proje),
                ('Veri Toplama Aracı / Araçları', belgeler.veri_toplama),
                ('Araştırma Uygulama İzni Başvuru Taahhütnamesi', belgeler.taahhutname),
                ('Araştırma/Tıbbi Araştırmalar İçin Etik Kuruldan Alınan Onay Belgesi', belgeler.etik_kurul),
                ('Ayrıntılı Bilgilendirme ve Gönüllü Katılım Formu', belgeler.gonullu_katilim),
                ('Veli Onam Formu', belgeler.veli_onam),
                ('Alanyazında Daha Önce Kullanılmış Veri Toplama Aracı Tercih Ediliyor İse Kullanıma İlişkin İzin',
                belgeler.olcek_izni),
                ('Enstitü Yönetim Kurulu Kararı', belgeler.enstitu_karari),
                ] %}
                {% for baslik, linkler in belge_listesi %}
                {% if linkler %}
                <div class="col-md-6 col-lg-4">
                    <div class="belge-card h-100">
                        <div class="d-flex align-items-start">
                            {% if 'Araştırma Proje' in baslik %}
                            <i class="bi bi-file-earmark-pdf text-primary me-2 fs-5"></i>
                            {% elif 'Veri Toplama Aracı' in baslik %}
                            <i class="bi bi-card-checklist text-success me-2 fs-5"></i>
                            {% elif 'Taahhütname' in baslik %}
                            <i class="bi bi-file-earmark-check text-success me-2 fs-5"></i>
                            {% elif 'Etik Kurul' in baslik %}
                            <i class="bi bi-shield-check text-warning me-2 fs-5"></i>
                            {% elif 'Gönüllü Katılım' in baslik %}
                            <i class="bi bi-person-check text-info me-2 fs-5"></i>
                            {% elif 'Veli Onam' in baslik %}
                            <i class="bi bi-people text-info me-2 fs-5"></i>
                            {% elif 'İzin' in baslik %}
                            <i class="bi bi-file-earmark-lock text-danger me-2 fs-5"></i>
                            {% else %}
                            <i class="bi bi-file-earmark-text text-secondary me-2 fs-5"></i>
                            {% endif %}
                            <div class="w-100">
                                <div class="fw-bold text-dark mb-1" style="font-size: 0.85rem;">{{ baslik }}</div>
                                {% for link in linkler %}
                                <div class="mb-1 d-flex align-items-center">
                                    <i class="bi bi-file-earmark-arrow-down text-muted small me-1"></i>
                                    {% set final_url = link.url if (link.url.startswith('http') or not link.local_path)
                                    else ("/belge-goster/" + link.local_path) %}
                                    <button type="button"
                                        class="btn btn-link p-0 text-start text-decoration-none text-truncate flex-grow-1"
                                        style="font-size: 0.8rem; max-width: 100%;"
                                        title="{{ link.clean_text if link.clean_text else link.text }}"
                                        onclick='belgeGoster({{ final_url|tojson }}, {{ (baslik + " - " + (link.clean_text if link.clean_text else link.text))|tojson }})'>
                                        {{ link.clean_text if link.clean_text else link.text }}
                                    </button>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════════ -->
    <!-- BÖLÜM 2: DEĞERLENDİRİCİ ATAMA                                    -->
    <!-- ═══════════════════════════════════════════════════════════════════ -->
    <div class="card glass-card mb-4">
        <div class="card-header section-header section-header--purple">
            <h5 class="mb-0"><i class="bi bi-people-fill me-2"></i>Değerlendirici Atama <small class="opacity-75">(en
                    fazla 2 kişi seçin)</small></h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                {% for d in degerlendiriciler %}
                <div class="col-md-6 col-lg-3">
                    <label class="deg-card {{ 'deg-card--selected' if d in atanmis_degerlendiriciler }}">
                        <input type="checkbox" name="degerlendiriciler" value="{{ d }}" class="deg-checkbox"
                            {{ 'checked' if d in atanmis_degerlendiriciler }}>
                        <div class="deg-card-body">
                            <i class="bi bi-person-circle deg-avatar"></i>
                            <span class="deg-name">{{ d }}</span>
                            <span
                                class="deg-count badge bg-{{ 'danger' if is_yuku[d] > 5 else 'warning' if is_yuku[d] > 2 else 'success' }}-subtle text-{{ 'danger' if is_yuku[d] > 5 else 'warning' if is_yuku[d] > 2 else 'success' }}">
                                {{ is_yuku[d] }} başvuru
                            </span>
                        </div>
                    </label>
                </div>
                {% endfor %}
            </div>
            <div id="degUyari" class="alert alert-warning mt-3 d-none py-2">
                <i class="bi bi-exclamation-triangle me-1"></i>En fazla 2 değerlendirici seçebilirsiniz!
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════════ -->
    <!-- BÖLÜM 3: ÖN KONTROL MADDELERİ                                    -->
    <!-- ═══════════════════════════════════════════════════════════════════ -->
    <div class="card glass-card mb-4">
        <div class="card-header section-header section-header--orange">
            <h5 class="mb-0"><i class="bi bi-list-check me-2"></i>Ön Kontrol Maddeleri</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0" id="onKontrolTablosu">
                    <thead>
                        <tr>
                            <th class="ps-4" style="width: 320px;">Madde</th>
                            <th class="text-center" style="width: 80px;">VAR</th>
                            <th class="text-center" style="width: 80px;">YOK</th>
                            <th class="text-center" style="width: 80px;">N/A</th>
                            <th>Açıklama</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for ok in on_kontroller %}
                        <tr
                            class="on-kontrol-row {{ 'on-kontrol-var' if ok.durum=='VAR' }}{{ 'on-kontrol-yok' if ok.durum=='YOK' }}{{ 'on-kontrol-na' if ok.durum=='N/A' }}">
                            <td class="ps-4 fw-medium">{{ ok.madde_adi }}</td>
                            <td class="text-center">
                                <input type="radio" name="on_kontrol_durum_{{ ok.sira }}" value="VAR"
                                    class="form-check-input radio-var" {{ 'checked' if ok.durum=='VAR' }}>
                            </td>
                            <td class="text-center">
                                <input type="radio" name="on_kontrol_durum_{{ ok.sira }}" value="YOK"
                                    class="form-check-input radio-yok" {{ 'checked' if ok.durum=='YOK' }}>
                            </td>
                            <td class="text-center">
                                <input type="radio" name="on_kontrol_durum_{{ ok.sira }}" value="N/A"
                                    class="form-check-input radio-na" {{ 'checked' if ok.durum=='N/A' }}>
                            </td>
                            <td>
                                <input type="text" name="on_kontrol_aciklama_{{ ok.sira }}"
                                    value="{{ ok.aciklama or '' }}" class="form-control form-control-sm"
                                    placeholder="Açıklama...">
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════════ -->
    <!-- BÖLÜM 4: KRİTERLER (30 Madde)                                    -->
    <!-- ═══════════════════════════════════════════════════════════════════ -->
    <div class="card glass-card mb-4">
        <div class="card-header section-header section-header--green d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-check2-square me-2"></i>Değerlendirme Kriterleri</h5>
            <div class="d-flex gap-2 no-print">
                <button type="button" class="btn btn-sm btn-outline-light" id="tumunuUygun">
                    <i class="bi bi-check-all me-1"></i>Tümünü Uygun
                </button>
                <button type="button" class="btn btn-sm btn-outline-light" id="tumunuTemizle">
                    <i class="bi bi-eraser me-1"></i>Temizle
                </button>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0" id="kriterTablosu">
                    <thead>
                        <tr>
                            <th class="ps-4 text-center" style="width: 60px;">No</th>
                            <th>Kriter</th>
                            <th class="text-center" style="width: 100px;">Uygun</th>
                            <th class="text-center" style="width: 100px;">Uygun Değil</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for k in kriterler %}
                        <tr class="kriter-row {{ 'kriter-uygun' if k.sonuc == 'UYGUN' }}{{ 'kriter-uygun-degil' if k.sonuc == 'UYGUN_DEGIL' }}"
                            data-kriter-no="{{ k.no }}">
                            <td class="ps-4 text-center">
                                <span class="kriter-no">{{ k.no }}</span>
                            </td>
                            <td class="kriter-metin">{{ k.metin }}</td>
                            <td class="text-center">
                                <input type="radio" name="kriter_sonuc_{{ k.no }}" value="UYGUN"
                                    class="form-check-input radio-uygun" {{ 'checked' if k.sonuc=='UYGUN' }}>
                            </td>
                            <td class="text-center">
                                <input type="radio" name="kriter_sonuc_{{ k.no }}" value="UYGUN_DEGIL"
                                    class="form-check-input radio-uygun-degil" {{ 'checked' if k.sonuc=='UYGUN_DEGIL'
                                    }}>
                            </td>
                        </tr>
                        <!-- Açıklama satırı (Uygun Değil seçilince açılır) -->
                        <tr class="kriter-aciklama-row {{ 'show' if k.sonuc == 'UYGUN_DEGIL' }}"
                            data-aciklama-for="{{ k.no }}">
                            <td></td>
                            <td colspan="3">
                                <div class="d-flex align-items-start gap-2">
                                    <i class="bi bi-chat-left-text text-danger mt-1"></i>
                                    <textarea name="kriter_aciklama_{{ k.no }}" rows="2"
                                        class="form-control form-control-sm kriter-aciklama-input"
                                        placeholder="Uygun değil gerekçesini yazın...">{{ k.aciklama or '' }}</textarea>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════════ -->
    <!-- BÖLÜM 5: UYGUN DEĞİL ÖZETİ                                      -->
    <!-- ═══════════════════════════════════════════════════════════════════ -->
    <div class="card ozet-card mb-4" id="ozetKart" style="display: none;">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-exclamation-triangle me-2"></i>Uygun Değil Özeti
                <span class="badge bg-light text-danger ms-2" id="ozetSayac">0</span>
            </h5>
        </div>
        <div class="card-body" id="ozetIcerik">
            <!-- JS ile doldurulacak -->
        </div>
    </div>

    <!-- Alt Kaydet + Yazdır Butonları -->
    <div class="d-flex justify-content-between mb-4 no-print">
        <button type="button" class="btn btn-outline-secondary btn-lg px-4" onclick="window.print()">
            <i class="bi bi-printer me-2"></i>Yazdır
        </button>
        <button type="submit" class="btn btn-success btn-lg px-5">
            <i class="bi bi-check2-all me-2"></i>Değerlendirmeyi Kaydet
        </button>
    </div>

</form>

<!-- Belge Görüntüleme Modalı -->
<div class="modal fade" id="belgeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content glass-card border-0">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title" id="belgeModalLabel">Belge Görüntüle</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
            </div>
            <div class="modal-body">
                <div class="ratio ratio-16x9" style="min-height: 70vh;">
                    <iframe id="belgeIframe" src="" frameborder="0"></iframe>
                </div>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                <a id="belgeYeniSekme" href="#" target="_blank" class="btn btn-primary">
                    <i class="bi bi-box-arrow-up-right me-1"></i>Yeni Sekmede Aç
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // ═══════════════════════════════════════════════════════════════
    // Belge Görüntüleme (Pop-up)
    // ═══════════════════════════════════════════════════════════════
    const belgeModal = new bootstrap.Modal(document.getElementById('belgeModal'));
    const belgeIframe = document.getElementById('belgeIframe');
    const belgeModalLabel = document.getElementById('belgeModalLabel');
    const belgeYeniSekme = document.getElementById('belgeYeniSekme');

    function belgeGoster(url, baslik) {
        belgeModalLabel.textContent = baslik;
        belgeIframe.src = url;
        belgeYeniSekme.href = url;
        belgeModal.show();
    }

    // Modal kapandığında iframe'i temizle (bellek ve ses çalma vb. için)
    document.getElementById('belgeModal').addEventListener('hidden.bs.modal', function () {
        belgeIframe.src = '';
    });

    // ═══════════════════════════════════════════════════════════════
    // Değerlendirici checkbox limiti (max 2)
    // ═══════════════════════════════════════════════════════════════
    const checkboxes = document.querySelectorAll('.deg-checkbox');
    const uyari = document.getElementById('degUyari');

    checkboxes.forEach(cb => {
        cb.addEventListener('change', function () {
            const checked = document.querySelectorAll('.deg-checkbox:checked');
            if (checked.length > 2) {
                this.checked = false;
                uyari.classList.remove('d-none');
                setTimeout(() => uyari.classList.add('d-none'), 3000);
                return;
            }
            this.closest('.deg-card').classList.toggle('deg-card--selected', this.checked);
        });
    });

    // ═══════════════════════════════════════════════════════════════
    // Ön Kontrol satır renklendirme
    // ═══════════════════════════════════════════════════════════════
    document.querySelectorAll('#onKontrolTablosu input[type="radio"]').forEach(radio => {
        radio.addEventListener('change', function () {
            const row = this.closest('tr');
            row.classList.remove('on-kontrol-var', 'on-kontrol-yok', 'on-kontrol-na');
            if (this.value === 'VAR') row.classList.add('on-kontrol-var');
            else if (this.value === 'YOK') row.classList.add('on-kontrol-yok');
            else if (this.value === 'N/A') row.classList.add('on-kontrol-na');
        });
    });

    // ═══════════════════════════════════════════════════════════════
    // Tümünü uygun yap
    // ═══════════════════════════════════════════════════════════════
    document.getElementById('tumunuUygun')?.addEventListener('click', function () {
        document.querySelectorAll('.radio-uygun').forEach(r => {
            r.checked = true;
            const row = r.closest('tr');
            row.className = 'kriter-row kriter-uygun';
            // Açıklama satırını gizle
            const no = row.dataset.kriterNo;
            const aciklamaRow = document.querySelector(`[data-aciklama-for="${no}"]`);
            if (aciklamaRow) aciklamaRow.classList.remove('show');
        });
        ozetiGuncelle();
    });

    // ═══════════════════════════════════════════════════════════════
    // Temizle
    // ═══════════════════════════════════════════════════════════════
    document.getElementById('tumunuTemizle')?.addEventListener('click', function () {
        document.querySelectorAll('#kriterTablosu input[type="radio"]').forEach(r => {
            r.checked = false;
        });
        document.querySelectorAll('.kriter-row').forEach(row => {
            row.className = 'kriter-row';
        });
        document.querySelectorAll('.kriter-aciklama-row').forEach(row => {
            row.classList.remove('show');
        });
        ozetiGuncelle();
    });

    // ═══════════════════════════════════════════════════════════════
    // Kriter satır renklendirme + açıklama alanı toggle
    // ═══════════════════════════════════════════════════════════════
    document.querySelectorAll('#kriterTablosu input[type="radio"]').forEach(radio => {
        radio.addEventListener('change', function () {
            const row = this.closest('tr');
            const no = row.dataset.kriterNo;
            const aciklamaRow = document.querySelector(`[data-aciklama-for="${no}"]`);

            row.classList.remove('kriter-uygun', 'kriter-uygun-degil');

            if (this.value === 'UYGUN') {
                row.classList.add('kriter-uygun');
                if (aciklamaRow) aciklamaRow.classList.remove('show');
            } else if (this.value === 'UYGUN_DEGIL') {
                row.classList.add('kriter-uygun-degil');
                if (aciklamaRow) {
                    aciklamaRow.classList.add('show');
                    // Açıklama alanına odaklan
                    setTimeout(() => {
                        const textarea = aciklamaRow.querySelector('textarea');
                        if (textarea) textarea.focus();
                    }, 300);
                }
            }
            ozetiGuncelle();
        });
    });

    // ═══════════════════════════════════════════════════════════════
    // Uygun Değil Özeti — dinamik güncelleme
    // ═══════════════════════════════════════════════════════════════
    function ozetiGuncelle() {
        const uygunDegilRadios = document.querySelectorAll('.radio-uygun-degil:checked');
        const ozetKart = document.getElementById('ozetKart');
        const ozetIcerik = document.getElementById('ozetIcerik');
        const ozetSayac = document.getElementById('ozetSayac');

        if (uygunDegilRadios.length === 0) {
            ozetKart.style.display = 'none';
            return;
        }

        ozetKart.style.display = 'block';

        // Toplam kriter sayısını bul
        const toplamKriter = document.querySelectorAll('.kriter-row').length;
        const uygunSayisi = document.querySelectorAll('.radio-uygun:checked').length;

        ozetSayac.textContent = `${uygunDegilRadios.length} / ${toplamKriter}`;

        let html = `<div class="mb-3">
            <strong>Toplam ${toplamKriter} kriterden ${uygunDegilRadios.length} tanesi uygun değil bulunmuştur.</strong>
            ${uygunSayisi > 0 ? ` <span class="text-success">(${uygunSayisi} kriter uygun)</span>` : ''}
        </div>`;

        html += '<div>';
        uygunDegilRadios.forEach(radio => {
            const row = radio.closest('tr');
            const no = row.dataset.kriterNo;
            const metin = row.querySelector('.kriter-metin')?.textContent?.trim() || '';
            const aciklamaRow = document.querySelector(`[data-aciklama-for="${no}"]`);
            const aciklama = aciklamaRow?.querySelector('textarea')?.value?.trim() || '';

            // Kriter metnini kısalt (ilk 120 karakter)
            const kisaMetin = metin.length > 120 ? metin.substring(0, 120) + '...' : metin;

            html += `<div class="ozet-item">
                <span class="ozet-item-no">Kriter ${no}:</span> ${kisaMetin}`;
            if (aciklama) {
                html += `<br><em class="text-muted ms-3"><i class="bi bi-chat-left-text me-1"></i>${aciklama}</em>`;
            }
            html += '</div>';
        });
        html += '</div>';

        ozetIcerik.innerHTML = html;
    }

    // Açıklama textarea'larındaki değişikliklerde de özeti güncelle
    document.querySelectorAll('.kriter-aciklama-input').forEach(textarea => {
        textarea.addEventListener('input', ozetiGuncelle);
    });

    // Sayfa yüklendiğinde özeti hesapla
    ozetiGuncelle();

    // ═══════════════════════════════════════════════════════════════
    // Form değişiklik uyarısı
    // ═══════════════════════════════════════════════════════════════
    let formChanged = false;
    document.getElementById('degerlendirmeForm').addEventListener('change', () => formChanged = true);
    document.getElementById('degerlendirmeForm').addEventListener('input', () => formChanged = true);
    window.addEventListener('beforeunload', (e) => {
        if (formChanged) {
            e.preventDefault();
            e.returnValue = '';
        }
    });
    document.getElementById('degerlendirmeForm').addEventListener('submit', () => formChanged = false);
</script>
{% endblock %}